// ==========
// From: '.'
// Zeta import: '../src/init.js'
/*global atom, hydrogen, console */(function(e){"use strict";var t={create:"POST",update:"PUT","delete":"DELETE",read:"GET"},n=function(t,n){return!t||!t[n]?null:e.core.isFunction(t[n])?t[n]():t[n]},r=0,i=function(e){return r+=1,e?e+r:r};e.declare("hydrogen",{own:{sync:function(r,i,s){var o=t[r],u={method:o,dataType:"json"};return s=s||{},s.url||(u.url=n(i,"url")),!s.data&&i&&(r==="create"||r==="update")&&(u.headers={"Content-type":"application/json"},u.type="json",u.data=JSON.stringify(i)),u=e.core.extend(u,s),e.ajax(u)},escape:function(e){return e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}},prototype:{}}),e.declare("hydrogen.Base",{own:{extend:function(t,n){return typeof t!="string"&&(n=t,t=null),e.declare({parent:this,name:t,prototype:n||{}})}},prototype:{properties:["id"],initialize:function(t){this.events=e.Events(this),this.settings=e.Settings(t).addEvents(this.events),this._configure()},configure:function(){},fire:function(e,t){this.events.fire(e,t),this.events.fire("all",[e].concat(t))},bind:function(e,t,n){n!==undefined?this.events.add(e,t.bind(n)):this.events.add(e,t)},unbind:function(e,t){this.events.remove(e,t)},sync:function(){return hydrogen.sync.apply(this,arguments)},_configure:function(){var e,t=this.properties.length,r,s;for(e=0;e<t;e++)r=this.properties[e],s=this.settings.get(r),s&&(this[r]=s,this[r]=n(this,r));this.cid=i(this.constructor.NAME)}}})})(atom),function(){"use strict";var e=/:\w+/g,t=/^[#\/]/,n=/\*\w+/g,r=/[-[\]{}()+?.,\\^$|#\s]/g,i=function(e){return Object.prototype.toString.call(e)=="[object RegExp]"};atom.declare("hydrogen._History",{history:[],routes:[],initialize:function(){this.bindMethods("_parse"),this.events=new atom.Events(this)},start:function(e){this.started=!0,this.navigate(atom.uri().anchor,{trigger:!0}),window.addEventListener("hashchange",this._parse)},stop:function(e){this.started=!1,window.removeEventListener("hashchange",this._parse)},push:function(e){this.history.push(e)},pop:function(){this.history.pop()},navigate:function(e,n){if(!this.started)return!1;var r=(e||"").replace(t,"");n=n||{};if(this.history[this.history.length-1]==r)return;this.push(r),n.replace?location.replace(location.toString().replace(/(javascript:|#).*$/,"")+"#"+r):location.hash=r,n.trigger&&this.loadUrl(e)},loadUrl:function(e,t){var n;this.routes.forEach(function(t){!n&&t.route.test(e)&&(n=t)}),n&&n.callback(e)},_parse:function(){var e=atom.uri().anchor;this.navigate(e,{trigger:!0})}}),hydrogen.history=new hydrogen._History,atom.declare("hydrogen.Router",{parent:hydrogen.Base,own:{extend:function(e){return atom.declare({parent:hydrogen.Router,prototype:e})}},prototype:{properties:["routes"],routes:{},initialize:function s(e){s.previous.apply(this,arguments),this._bindRoutes(),this.configure()},route:function(e,t,n){i(e)||(e=this._routeToRegExp(e)),n||(n=this[t]),hydrogen.history.routes.unshift({route:e,callback:function(r){var i=this._extractParameters(e,r);n&&n.apply(this,i),this.fire(t,[this,e,i])}.bind(this)})},navigate:function(e,t){hydrogen.history.navigate(e,t)},_extractParameters:function(e,t){return e.exec(t).slice(1)},_routeToRegExp:function(t){return t=t.replace(r,"\\$&").replace(e,"([^/]+)").replace(n,"(.*?)"),new RegExp("^"+t+"$")},_bindRoutes:function(){var e,t,n,r=[];for(e in this.routes)r.unshift([e,this.routes[e]]);this.routes=[];for(t=0,n=r.length;t<n;t++)this.route(r[t][0],r[t][1],this[r[t][1]])}}})}(),function(e){"use strict";var t=/<%([\s\S]+?)%>/g,n=/<%=([\s\S]+?)%>/g,r=/<%-([\s\S]+?)%>/g,i=/.^/,s=function(e){return e.replace(/\\\\/g,"\\").replace(/\\'/g,"'")};e.declare("hydrogen.Template",{tmpl:null,initialize:function(t,n){var r=typeof t=="string"?e.dom(t):t,i=r.html();this.defaults=n||{},this.tmpl=this.constructor.compile(i)},render:function(t){var n=this.tmpl||this.compile(),r=e.core.append(this.defaults,t||{});return n(t)},own:{compile:function(e,o){var u="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(r||i,function(e,t){return"',hydrogen.escape("+s(t)+"),'"}).replace(n||i,function(e,t){return"',"+s(t)+",'"}).replace(t||i,function(e,t){return"');"+s(t).replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",a=new Function("obj","hydrogen",u);return o?a(o,hydrogen):function(e){return a.call(this,e,hydrogen)}}}})}(atom),function(){"use strict";var e=/^(\S+)\s*(.*)$/;atom.declare("hydrogen.View",{parent:hydrogen.Base,prototype:{properties:["model","collection","el","id","attrs","className","tagName","template"],template:null,tagName:"div",attributes:{},actions:{},initialize:function t(e){t.previous.apply(this,arguments),this.bindMethods("render"),this.setElement(this.el||atom.dom.create(this.tagName,this.attributes)),this.template!==null&&(this.template=new hydrogen.Template(this.template)),this.configure()},configure:function(){return this},render:function(){if(this.template&&this.el){var e=this.template.render(this.settings.values);this.el.html(e)}return this},destroy:function(){return this.el.destroy(),this},setElement:function(e){this.el=atom.dom(e),this._bindEvents()},find:function(e){return this.el.find(e)},_bindEvents:function(){var t,n,r,i,s,o=this.actions;for(n in o){t=o[n],atom.core.isFunction(t)||(t=this[o[n]]);if(!t)continue;r=n.match(e),i=r[1],s=r[2],s===""?this.el.bind(i,t.bind(this)):this.el.delegate(s,i,t.bind(this))}}}})}(),function(){"use strict";atom.declare("hydrogen.Model",{parent:hydrogen.Base,prototype:{properties:["collection"],idAttribute:"id",initialize:function e(t,n){e.previous.call(this,n);var r=this.settings.get("parse");r&&(t=this.parse(t)),this.attrs=(new atom.Settings).set(this.defaults).set(t),this.configure()},get id(){return this.get(this.idAttribute)},set id(e){this.set(this.idAttribute,e)},get:function(e){return this.attrs.get(e)},set:function(e,t,n){var r,i=n||{},s=atom.core.objectize(e,t),o=i.changes={};if(!this._validate(s,i))return!1;this._id=this.id,Object.map(s,function(e,t){e!=this.get(t)&&(o[t]=e)}.bind(this)),this.attrs.set(s);if(!i.silent){for(r in o)this.events.fire("change:"+r,[this,this.get(r),i]);this.fire("change",[this,this.collection,s])}return this},unset:function(e,t){this.set(e,null,t)},has:function(e){return this.get(e)!==undefined&&this.get(e)!==null},escape:function(e){var t=this.get(e);return hydrogen.escape(t==null?"":t.toString())},toJSON:function(){return atom.clone(this.attrs.values)},parse:function(e,t){return e},isNew:function(){return this.id===undefined||this.id===null},url:function(){var e=this.urlRoot||this.collection.url;return this.isNew()?e:e+(e.charAt(e.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},clone:function(){return new this.constructor(this.attrs.values,this.settings.values)},save:function(e,t,n){var r,i,s=this,o,u;return typeof e=="object"||e===null?(r=e,n=t):(r={},r[e]=t),r&&this.set(r),n=atom.clone(n||{}),o=n.onLoad,n.onLoad=function(e){var t=s.parse(e);s.set(s.parse(e)),o?o(s,e):s.fire("sync",[e,n])},u=this.isNew()?"create":"update",this.sync(u,this,n)},fetch:function(e){e=e?atom.clone(e):{};var t=this,n=e.onLoad;return e.onLoad=function(r){if(!t.set(t.parse(r),e))return!1;n&&n(t,r)},this.sync("read",this,e)},destroy:function(e){var t=this,n,r,i;return e=atom.clone(e||{}),n=e.onLoad,r=function(){t.fire("destroy",[t,t.collection,e])},this.isNew()?(r(),!1):(e.onLoad=function(r){n?n(t,r):t.fire("sync",[r,e])},i=this.sync("delete",this,e),r(),i)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=atom.core.append(atom.clone(this.attrs.values),e);var n=this.validate(e,t);return n?(t&&t.error?t.error(this,n,t):this.fire("error",[this,n,t]),!1):!0}}})}(),function(){"use strict";atom.declare("hydrogen.Collection",{parent:hydrogen.Base,prototype:{properties:["id","model","comparator","url"],model:hydrogen.Model,initialize:function e(t,n){this.bindMethods(["_onModelEvent","_removeReference"]),e.previous.call(this,n),this.models=[],this.reset(t||[],n),this.configure()},toJSON:function(){return this.models.map(function(e){return e.toJSON()})},get length(){return this.models.length},set length(e){this.models.length=e},get first(){return this.models[0]},set first(e){throw"Not allowed"},get last(){return this.models[this.length-1]},set last(e){throw"Not allowed"},get:function(e){return e==null?undefined:this._byId[e.id!=null?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},pluck:function(e){return this.models.map(function(t){return t.get(e)})},sort:function(e){e=e||{};if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var t=this.comparator.bind(this);return this.models.sort(t),e.silent||this.fire("reset",[this,e]),this},add:function(e,t){t=atom.clone(t||{});var n=[],r,i=this._byId,s=this._byCid,o=this,u=this._onModelEvent,a=this._prepareModel.bind(this);return e=atom.isArrayLike(e)?e.slice():[e],e.forEach(function(e){e=a(e),e.bind("all",u),!i[e.id]&&!s[e.cid]&&(s[e.cid]=e,e.id!=null&&(i[e.id]=e),n.push(e))}),r=t.at!=null?t.at:this.length,Array.prototype.splice.apply(this.models,[r,0].concat(n)),n.forEach(function(e){t.index=r++,t.silent||e.fire("add",[e,o,t])}),this},create:function(e,t){t=atom.clone(t||{});var n=this,r=t.onLoad;return e=this._prepareModel(e,t),e?(this.add(e,t),t.onLoad=function(e,n,i){r?r(e,n):e.fire("sync",[n,t])},e.save(null,t),e):!1},remove:function(e,t){var n,r,i,s;t=atom.clone(t||{}),e=atom.isArrayLike(e)?e.slice():[e];for(n=0,r=e.length;n<r;n++){s=this.getByCid(e[n])||this.get(e[n]);if(!s)continue;delete this._byId[s.id],delete this._byCid[s.cid],i=this.models.indexOf(s),this.models.splice(i,1),t.silent||(t.index=i,s.events.fire("remove",[s,this,t]),this.fire("remove",[s,this,t])),this._removeReference(s)}return this},fetch:function(e){e=atom.clone(e||{}),e.parse===undefined&&(e.parse=!0);var t=this,n=e.onLoad;return e.onLoad=function(r){t[e.add?"add":"reset"](t.parse(r),e),n&&n(t,r)},this.sync("read",this,e)},parse:function(e){return e},reset:function(e,t){t=t||{},this.models.forEach(this._removeReference),this._reset(),this.add(e,atom.extend({silent:!0},t)),t.silent||this.fire("reset",[e,t])},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){t=atom.clone(t||{});if(e instanceof hydrogen.Model)e.collection||(e.collection=this);else{var n=e;t.collection=this,e=new this.model(n,t)}return e},_onModelEvent:function(e,t,n,r){if((e=="add"||e=="remove")&&n!=this)return;e=="destroy"&&this.remove(t,r),e=="change"&&(delete this._byId[t._id],this._byId[t.id]=t),this.fire(e,[t,n,r])},_removeReference:function(e){var t=this._onModelEvent;this==e.collection&&delete e.collection,e.unbind("all",t)}}})}();