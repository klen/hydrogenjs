// ==========
// From: '/home/klen/Projects/hydrogen/hydrogen.js'
// Zeta import: '/home/klen/Projects/hydrogen/src/init.js'
/*global atom, hydrogen, console */(function(a){"use strict";var b={create:"POST",update:"PUT","delete":"DELETE",read:"GET"},c=function(b,c){return!b||!b[c]?null:a.core.isFunction(b[c])?b[c]():b[c]},d=0,e=function(a){return d+=1,a?a+d:d};a.declare("hydrogen",{own:{sync:function(d,e,f){var g=b[d],h={method:g,dataType:"json"};return f=f||{},f.url||(h.url=c(e,"url")),!f.data&&e&&(d==="create"||d==="update")&&(h.headers={"Content-type":"application/json"},h.type="json",h.data=JSON.stringify(e)),h=a.core.extend(h,f),a.ajax(h)},escape:function(a){return a.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}}}),a.declare("hydrogen.Base",{own:{extend:function(b){return a.declare({parent:this,proto:b||{}})}},proto:{properties:["id"],initialize:function(b){this.events=a.Events(this),this.settings=a.Settings().set(b).addEvents(this.events),this._configure()},configure:function(){},fire:function(a,b){this.events.fire(a,b),this.events.fire("all",[a].concat(b))},bind:function(a,b,c){c!==undefined?this.events.add(a,b.bind(c)):this.events.add(a,b)},unbind:function(a,b){this.events.remove(a,b)},sync:function(){return hydrogen.sync.apply(this,arguments)},_configure:function(){var a,b=this.properties.length,d,f;for(a=0;a<b;a++)d=this.properties[a],f=this.settings.get(d),f&&(this[d]=f,this[d]=c(this,d));this.cid=e(this.constructor.NAME)}}})})(atom),function(){"use strict";var a=/:\w+/g,b=/^[#\/]/,c=/\*\w+/g,d=/[-[\]{}()+?.,\\^$|#\s]/g,e=function(a){return Object.prototype.toString.call(a)=="[object RegExp]"};atom.declare("hydrogen._History",{history:[],routes:[],initialize:function(){this.bindMethods("_parse"),this.events=new atom.Events(this)},start:function(a){this.started=!0,this.navigate(atom.uri().anchor,{trigger:!0}),window.addEventListener("hashchange",this._parse)},stop:function(a){this.started=!1,window.removeEventListener("hashchange",this._parse)},push:function(a){this.history.push(a)},pop:function(){this.history.pop()},navigate:function(a,c){if(!this.started)return!1;var d=(a||"").replace(b,"");c=c||{};if(this.history[this.history.length-1]==d)return;this.push(d),c.replace?location.replace(location.toString().replace(/(javascript:|#).*$/,"")+"#"+d):location.hash=d,c.trigger&&this.loadUrl(a)},loadUrl:function(a,b){var c;this.routes.forEach(function(b){!c&&b.route.test(a)&&(c=b)}),c&&c.callback(a)},_parse:function(){var a=atom.uri().anchor;this.navigate(a,{trigger:!0})}}),hydrogen.history=new hydrogen._History,atom.declare("hydrogen.Router",{parent:hydrogen.Base,own:{extend:function(a){return atom.declare({parent:hydrogen.Router,proto:a})}},proto:{properties:["routes"],routes:{},initialize:function f(a){f.previous.apply(this,arguments),this._bindRoutes(),this.configure()},route:function(a,b,c){e(a)||(a=this._routeToRegExp(a)),c||(c=this[b]),hydrogen.history.routes.unshift({route:a,callback:function(d){var e=this._extractParameters(a,d);c&&c.apply(this,e),this.fire(b,[this,a,e])}.bind(this)})},navigate:function(a,b){hydrogen.history.navigate(a,b)},_extractParameters:function(a,b){return a.exec(b).slice(1)},_routeToRegExp:function(b){return b=b.replace(d,"\\$&").replace(a,"([^/]+)").replace(c,"(.*?)"),new RegExp("^"+b+"$")},_bindRoutes:function(){var a,b,c,d=[];for(a in this.routes)d.unshift([a,this.routes[a]]);this.routes=[];for(b=0,c=d.length;b<c;b++)this.route(d[b][0],d[b][1],this[d[b][1]])}}})}(),function(a){"use strict";var b=/<%([\s\S]+?)%>/g,c=/<%=([\s\S]+?)%>/g,d=/<%-([\s\S]+?)%>/g,e=/.^/,f=function(a){return a.replace(/\\\\/g,"\\").replace(/\\'/g,"'")};a.declare("hydrogen.Template",{tmpl:null,initialize:function(b,c){var d=typeof b=="string"?a.dom(b):b,e=d.html();this.defaults=c||{},this.tmpl=this.constructor.compile(e)},render:function(b){var c=this.tmpl||this.compile(),d=a.core.append(this.defaults,b||{});return c(b)},own:{compile:function(a,g){var h="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(d||e,function(a,b){return"',hydrogen.escape("+f(b)+"),'"}).replace(c||e,function(a,b){return"',"+f(b)+",'"}).replace(b||e,function(a,b){return"');"+f(b).replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",i=new Function("obj","hydrogen",h);return g?i(g,hydrogen):function(a){return i.call(this,a,hydrogen)}}}})}(atom),function(){"use strict";var a=/^(\S+)\s*(.*)$/;atom.declare("hydrogen.View",{parent:hydrogen.Base,proto:{properties:["model","collection","el","id","attrs","className","tagName","template"],template:null,tagName:"div",attributes:{},actions:{},initialize:function b(a){b.previous.apply(this,arguments),this.setElement(this.el||atom.dom.create(this.tagName,this.attributes)),this.template!==null&&(this.template=new hydrogen.Template(this.template)),this.configure()},configure:function(){return this},render:function(){if(this.template&&this.el){var a=this.template.render(this.settings.values);this.el.html(a)}return this},destroy:function(){return this.el.destroy(),this},setElement:function(a){this.el=atom.dom(a),this._bindEvents()},find:function(a){return this.el.find(a)},_bindEvents:function(){var b,c,d,e,f,g=this.actions;for(c in g){b=g[c],atom.core.isFunction(b)||(b=this[g[c]]);if(!b)continue;d=c.match(a),e=d[1],f=d[2],f===""?this.el.bind(e,b.bind(this)):this.el.delegate(f,e,b.bind(this))}}}})}(),function(){"use strict",atom.declare("hydrogen.Model",{parent:hydrogen.Base,proto:{properties:["collection"],idAttribute:"id",initialize:function a(b,c){a.previous.call(this,c);var d=this.settings.get("parse");d&&(b=this.parse(b)),this.attrs=(new atom.Settings).set(this.defaults).set(b),this.configure()},get id(){return this.get(this.idAttribute)},set id(a){this.set(this.idAttribute,a)},get:function(a){return this.attrs.get(a)},set:function(a,b,c){var d=c||{};return this._id=this.id,this.attrs.set(a,b),d.silent||this.fire("change",[this,this.collection,arguments]),this},unset:function(a,b){this.set(a,null,b)},has:function(a){return this.get(a)!==undefined&&this.get(a)!==null},escape:function(a){var b=this.get(a);return hydrogen.escape(b==null?"":b.toString())},toJSON:function(){return atom.clone(this.attrs.values)},parse:function(a,b){return a},isNew:function(){return this.id===undefined||this.id===null},url:function(){var a=this.urlRoot||this.collection.url;return this.isNew()?a:a+(a.charAt(a.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},clone:function(){return new this.constructor(this.attrs.values,this.settings.values)},save:function(a,b,c){var d,e,f=this,g,h;return typeof a=="object"||a===null?(d=a,c=b):(d={},d[a]=b),d&&this.set(d),c=atom.clone(c||{}),g=c.onLoad,c.onLoad=function(a){var b=f.parse(a);f.set(f.parse(a)),g?g(f,a):f.fire("sync",[a,c])},h=this.isNew()?"create":"update",this.sync(h,this,c)},fetch:function(a){a=a?atom.clone(a):{};var b=this,c=a.onLoad;return a.onLoad=function(d){if(!b.set(b.parse(d),a))return!1;c&&c(b,d)},this.sync("read",this,a)},destroy:function(a){var b=this,c,d,e;return a=atom.clone(a||{}),c=a.onLoad,d=function(){b.fire("destroy",[b,b.collection,a])},this.isNew()?(d(),!1):(a.onLoad=function(d){c?c(b,d):b.fire("sync",[d,a])},e=this.sync("delete",this,a),d(),e)}}})}(),function(){"use strict",atom.declare("hydrogen.Collection",{parent:hydrogen.Base,proto:{properties:["id","model","comparator","url"],model:hydrogen.Model,initialize:function a(b,c){this.bindMethods(["_onModelEvent","_removeReference"]),a.previous.call(this,c),this.models=[],this.reset(b||[],c),this.configure()},toJSON:function(){return this.models.map(function(a){return a.toJSON()})},get length(){return this.models.length},set length(a){this.models.length=a},get first(){return this.models[0]},set first(a){throw"Not allowed"},get last(){return this.models[this.length-1]},set last(a){throw"Not allowed"},get:function(a){return a==null?undefined:this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},pluck:function(a){return this.models.map(function(b){return b.get(a)})},sort:function(a){a=a||{};if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var b=this.comparator.bind(this);return this.models.sort(b),a.silent||this.fire("reset",[this,a]),this},add:function(a,b){b=atom.clone(b||{});var c=[],d,e=this._byId,f=this._byCid,g=this,h=this._onModelEvent,i=this._prepareModel.bind(this);return a=atom.isArrayLike(a)?a.slice():[a],a.forEach(function(a){a=i(a),a.bind("all",h),!e[a.id]&&!f[a.cid]&&(f[a.cid]=a,a.id!=null&&(e[a.id]=a),c.push(a))}),d=b.at!=null?b.at:this.length,Array.prototype.splice.apply(this.models,[d,0].concat(c)),c.forEach(function(a){b.index=d++,b.silent||a.fire("add",[a,g,b])}),this},create:function(a,b){b=atom.clone(b||{});var c=this,d=b.onLoad;return a=this._prepareModel(a,b),a?(this.add(a,b),b.onLoad=function(a,c,e){d?d(a,c):a.fire("sync",[c,b])},a.save(null,b),a):!1},remove:function(a,b){var c,d,e,f;b=atom.clone(b||{}),a=atom.isArrayLike(a)?a.slice():[a];for(c=0,d=a.length;c<d;c++){f=this.getByCid(a[c])||this.get(a[c]);if(!f)continue;delete this._byId[f.id],delete this._byCid[f.cid],e=this.models.indexOf(f),this.models.splice(e,1),b.silent||(b.index=e,f.events.fire("remove",[f,this,b]),this.fire("remove",[f,this,b])),this._removeReference(f)}return this},fetch:function(a){a=atom.clone(a||{}),a.parse===undefined&&(a.parse=!0);var b=this,c=a.onLoad;return a.onLoad=function(d){b[a.add?"add":"reset"](b.parse(d),a),c&&c(b,d)},this.sync("read",this,a)},parse:function(a){return a},reset:function(a,b){b=b||{},this.models.forEach(this._removeReference),this._reset(),this.add(a,atom.extend({silent:!0},b)),b.silent||this.fire("reset",[a,b])},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(a,b){b=atom.clone(b||{});if(a instanceof hydrogen.Model)a.collection||(a.collection=this);else{var c=a;b.collection=this,a=new this.model(c,b)}return a},_onModelEvent:function(a,b,c,d){if((a=="add"||a=="remove")&&c!=this)return;a=="destroy"&&this.remove(b,d),a=="change"&&(delete this._byId[b._id],this._byId[b.id]=b),this.fire(a,[b,c,d])},_removeReference:function(a){var b=this._onModelEvent;this==a.collection&&delete a.collection,a.unbind("all",b)}}})}();